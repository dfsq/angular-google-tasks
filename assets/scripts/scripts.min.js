/*! angular-google-tasks - v0.1.0 - 2015-05-15 11:10 */
!function(){"use strict";function googleTasksConfig(googleApiProvider){googleApiProvider.setConfig({clientId:"421579928051-79o2r8382t52m5tdls381l4rlns6hr95.apps.googleusercontent.com",apiKey:"AIzaSyCoFGS6BzXCErahLsI8GFsOP-xQ5P7Qc0U",scopes:["https://www.googleapis.com/auth/tasks","https://www.googleapis.com/auth/plus.me"]})}function googleTasksRun($rootScope,$timeout,$q,$location,application,googleApi,security){var gapiPromise,timeout,routeChangePromise,onRouteChangeSuccessHandler,onRouteChangeSuccess;gapiPromise=googleApi.init().then(function(data){return security.setAuthObject(data)}),timeout=$timeout(angular.noop,500,!1),routeChangePromise=$q.defer(),onRouteChangeSuccessHandler=function(){routeChangePromise.resolve(),onRouteChangeSuccess()},onRouteChangeSuccess=$rootScope.$on("$routeChangeSuccess",onRouteChangeSuccessHandler),security.authState=gapiPromise,$q.all([timeout,gapiPromise,routeChangePromise.promise]).then(function(){application.ready()}),$rootScope.$on("$locationChangeStart",function(){var path=$location.path();(""===path||"/"===path)&&(application.ready(function(){var redirectPath=security.isSignedIn()?"/tasklists":"/login";$location.path(redirectPath)}),onRouteChangeSuccessHandler())});var resolveOnce=!1;$rootScope.$on("$routeChangeError",function(event,current){resolveOnce||(resolveOnce=!0,routeChangePromise.resolve(),onRouteChangeSuccess()),application.ready(function(){var onRouteError=current.onRouteError;onRouteError&&onRouteError.redirectTo&&$location.path(onRouteError.redirectTo)})})}googleTasksConfig.$inject=["googleApiProvider"],googleTasksRun.$inject=["$rootScope","$timeout","$q","$location","application","googleApi","security"],angular.module("googleTasks",["ui.bootstrap","ngRoute","ngAnimate","ngSanitize","components.services","components.directives","login","tasklists","tasks"],googleTasksConfig).run(googleTasksRun)}(),angular.extend=function extendDeep(dst){"use strict";return angular.forEach(arguments,function(obj){obj!==dst&&angular.forEach(obj,function(value,key){dst[key]&&dst[key].constructor&&dst[key].constructor===Object?extendDeep(dst[key],value):dst[key]=value})}),dst},angular.module("components.directives",[]),angular.module("components.services.security",[]),angular.module("components.services",["components.services.application","components.services.googleApi","components.services.storage","components.services.tasks","components.services.security","components.services.routeFilter","components.services.sModal"]),angular.module("components.services.storage",["storage.cache","storage.local"]),function(){"use strict";function login($routeProvider,securityProvider){$routeProvider.when("/login",{templateUrl:"login/login.html",controller:"loginController",resolve:{auth:securityProvider.requestGuest},onRouteError:{redirectTo:"/tasklists"},page:{title:"Sign In | "+document.title,className:"login-screen"}})}login.$inject=["$routeProvider","securityProvider"],angular.module("login",["ngRoute"],login)}(),function(){"use strict";function tasklists(routeFilterProvider,securityProvider){routeFilterProvider.registerFilter("/tasklists:path?",{resolve:{auth:securityProvider.requestSignedIn},onRouteError:{redirectTo:"/login"}}),routeFilterProvider.when("/tasklists",{templateUrl:"tasklists/tasklists.html",controller:"tasklistsController",page:{className:"tasklists-screen slide",title:"Task Lists | "+document.title}})}tasklists.$inject=["routeFilterProvider","securityProvider"],angular.module("tasklists",["ngRoute"],tasklists)}(),function(){"use strict";function tasks(routeFilterProvider){routeFilterProvider.when("/tasklists/:title/:id",{templateUrl:"tasks/tasks.html",controller:"tasksController",page:{className:"tasks-screen slide",title:"Tasks | "+document.title}})}tasks.$inject=["routeFilterProvider"],angular.module("tasks",[],tasks)}(),angular.module("googleTasks").controller("appController",["$scope","$route","application",function($scope,$route,application){application.ready(function(){$scope.appReady=!0}),$scope.$on("$routeChangeSuccess",function(newVal,oldVal){oldVal!==newVal&&($scope.routeClassName=$route.current.page.className,document.title=$route.current.page.title)}),$scope.back=function(){window.history.back()}}]),function(){"use strict";function backTransition($rootScope,$location){return{link:function(scope,element){var backClass="reverse";$rootScope.$on("$locationChangeSuccess",function(){$rootScope.currentPath=$location.path(),element.removeClass(backClass)}),$rootScope.$watch(function(){return $location.path()},function(newPath){$rootScope.currentPath===newPath&&element.addClass(backClass)})}}}backTransition.$inject=["$rootScope","$location"],angular.module("components.directives").directive("backTransition",backTransition)}(),function(){"use strict";function colorize($timeout){return{link:function(scope,element,attrs){$timeout(function(){var textElement=element[0].querySelector(attrs.colorize),text=angular.element(textElement).text();element.css("background-color",str2hsl(text))})}}}var str2hsl=function(){function getRange(code){for(var range,i=0;i<charRanges.length;i++)if(range=charRanges[i],range[0]<=code&&code<=range[1])return range;return null}function getAverage(arr){return Math.round(arr.reduce(function(prev,curr){return prev+curr},0)/arr.length)}var charRanges=[[32,127],[1024,1279]];return function(str){var i,range,average,code,hue,avgs=[];for(i=0;i<str.length;i++)code=str.charCodeAt(i),range=getRange(code),range&&avgs.push(Math.round(100*(code-range[0])/(range[1]-range[0])));return average=getAverage(avgs),hue=Math.round(360*average/100),"hsla("+hue+", 20%, 40%, .5)"}}();colorize.$inject=["$timeout"],angular.module("components.directives").directive("colorize",colorize)}(),angular.module("components.services.application",[]).factory("application",["$q",function($q){var stack=[],service={isReady:!1,ready:function(callback){if("function"==typeof callback)service.isReady?callback():stack.push(callback);else{service.isReady=!0;for(var i=stack.length-1;i>=0;i--)stack[i]()}},readyState:function(){var deferred=$q.defer();return service.ready(deferred.resolve),deferred.promise}};return service}]),angular.module("components.services.googleApi",[]).provider("googleApi",function(){var config={};this.setConfig=function(configObj){config=configObj},this.$get=["$q",function($q){var service={init:function(loginCheck){var deferred=$q.defer();window.gapiLoaded=function(){gapi.client.setApiKey(config.apiKey),delete window.gapiLoaded,deferred.resolve()};var script=document.createElement("script");return script.src="https://apis.google.com/js/client.js?onload=gapiLoaded",document.body.appendChild(script),"undefined"==typeof loginCheck&&(loginCheck=!0),loginCheck?deferred.promise.then(function(){return service.login(!0).then(function(data){return data},function(data){return data})}):deferred.promise},login:function(immediate){var deferred=$q.defer();return window.setTimeout(function(){service.checkAuth("undefined"==typeof immediate?!1:immediate,deferred)},1),deferred.promise},checkAuth:function(immediate,deferred){function handleAuthResult(authResult){authResult&&!authResult.error?deferred.resolve(authResult):deferred.reject(authResult)}gapi.auth.authorize({client_id:config.clientId,scope:config.scopes,immediate:immediate},handleAuthResult)}};return service}]}),angular.module("components.services.routeFilter",["ngRoute"]).provider("routeFilter",["$routeProvider",function($routeProvider){function getExtendedConfig(path){for(var key in registeredFilters)if(new RegExp(key).test(path))return registeredFilters[key];return{}}var registeredFilters={};this.registerFilter=function(path,rule){path="^"+path.replace(/\//g,"\\/").replace(/:path/g,"(\\/.+?)")+"$",registeredFilters[path]=rule},this.when=function(path,config){return config=angular.extend({},getExtendedConfig(path),config),$routeProvider.when(path,config),this},this.otherwise=$routeProvider.otherwise,this.$get=angular.noop}]),function(){"use strict";function sModal($q,$controller,$compile,$document){var getTemplate=function(content){return'<div class="modal fade simple-modal"><div class="modal-dialog"><div class="modal-content">'+content+'</div></div></div><div class="modal-backdrop fade in"></div>'};return{open:function(config){function cleanUp(){compiled.removeClass("in"),setTimeout(function(){compiled.remove()},50),scope.$destroy()}var tpl,compiled,deferred=$q.defer(),scope=config.scope.$new(),$modalInstance={close:function(){cleanUp(),deferred.resolve.apply(null,arguments)},dismiss:function(){cleanUp(),deferred.reject()}};return scope.$modalInstance=$modalInstance,config.controller&&$controller(config.controller,{$scope:scope,$modalInstance:$modalInstance}),config.templateUrl?tpl=getTemplate("<div ng-include=\"'"+config.templateUrl+"'\"></div>"):config.template&&(tpl=getTemplate(config.template)),compiled=$compile(tpl)(scope),config.windowClass&&compiled.addClass(config.windowClass),$document.find("body").append(compiled),setTimeout(function(){compiled.addClass("in")},50),deferred.promise}}}sModal.$inject=["$q","$controller","$compile","$document"],angular.module("components.services.sModal",[]).factory("sModal",sModal)}(),angular.module("components.services.security").provider("security",{requestSignedIn:["security",function(security){return security.requestSignedIn()}],requestGuest:["security",function(security){return security.requestGuest()}],$get:["$q",function($q){var service={authState:null,authObject:null,setAuthObject:function(data){return service.authObject=data,service.authObject},isSignedIn:function(){return this.authObject&&this.authObject.status&&this.authObject.status.signed_in},requestAuthState:function(){return service.authObject?$q.when(service.authObject):service.authState},requestSignedIn:function(){return service.requestAuthState().then(function(){return service.isSignedIn()?!0:$q.reject("authorization required")})},requestGuest:function(){return service.requestAuthState().then(function(){return service.isSignedIn()?$q.reject("already signed in"):!0})}};return service}]}),function(){"use strict";function cache($q){function cacheFunction(key,setterFunction,refresh){return refresh===!0&&cacheFunction.clear(key),cacheData[key]?$q.when(cacheData[key]):setterFunction().then(function(data){return cacheData[key]=data,data})}var cacheData={};return cacheFunction.get=function(key){return cacheData[key]},cacheFunction.clear=function(key){delete cacheData[key]},cacheFunction}cache.$inject=["$q"],angular.module("storage.cache",[]).factory("cache",cache)}(),function(){"use strict";function local(){var storage=localStorage,service={};return service.set=function(key,value){value=JSON.stringify(value),storage.setItem(key,value)},service.get=function(key){return JSON.parse(storage.getItem(key)||"null")},service}angular.module("storage.local",[]).factory("local",local)}(),function(){"use strict";function tasks($http,cache,local){function groupTasks(tasks){var task,i,idIndexMap={};for(i=0;i<tasks.length;i++)if(task=tasks[i],idIndexMap[task.id]=task,task.parent){var parent=idIndexMap[task.parent];parent&&(parent.children=parent.children||[],parent.children.push(task),tasks.splice(i--,1))}return tasks}function getCompleted(data){var n=0;return data.forEach(function(el){"completed"===el.status&&n++}),n}var basePath="https://www.googleapis.com/tasks/v1",params={params:{access_token:gapi.auth.getToken().access_token}};return{getTaskLists:function(refresh){return cache("tasklists",function(){return $http.get(basePath+"/users/@me/lists",params).then(function(response){return response.data})},refresh).then(function(data){return data.items.map(function(el){var localItem=local.get(el.id);return localItem&&(el.stats=localItem),el})})},getTasks:function(tasklistId,refresh){return cache("tasks"+tasklistId,function(){return $http.get(basePath+"/lists/"+tasklistId+"/tasks",params).then(function(response){return response.data.items||[]})},refresh).then(function(items){var total=items.length,completed=getCompleted(items),grouped=groupTasks(items);return grouped.total=total,grouped.completed=completed,grouped.todo=total-completed,local.set(tasklistId,{items:items,total:total,completed:completed,todo:total-completed}),grouped})},createTaskList:function(data){return $http.post(basePath+"/users/@me/lists",data,params)},updateTaskList:function(taskList,data){return taskList=angular.extend(taskList,data),$http.put(basePath+"/users/@me/lists/"+taskList.id,taskList,params)},deleteTaskList:function(tasklistId){return $http["delete"](basePath+"/users/@me/lists/"+tasklistId,params)},moveTask:function(tasklistId,taskId){return $http(basePath+"/lists/"+tasklistId+"/tasks/"+taskId+"/move",params)},createTask:function(tasklistId,data){return $http.post(basePath+"/lists/"+tasklistId+"/tasks",data,params)},deleteTask:function(tasklistId,taskId){return $http["delete"](basePath+"/lists/"+tasklistId+"/tasks/"+taskId,params)},updateTask:function(tasklistId,task,data){return task=angular.extend(task,data),$http.put(basePath+"/lists/"+tasklistId+"/tasks/"+task.id,task,params)}}}tasks.$inject=["$http","cache","local"],angular.module("components.services.tasks",[]).factory("tasks",tasks)}(),function(){"use strict";function loginController($scope,$location,googleApi,security,sModal){$scope.login=function(){googleApi.login().then(function(data){security.authObject=data,$location.path("/tasklists")},function(data){$scope.error=!0})},$scope.about=function(){sModal.open({scope:$scope,templateUrl:"login/about.html"})}}loginController.$inject=["$scope","$location","googleApi","security","sModal"],angular.module("login").controller("loginController",loginController)}(),function(){"use strict";function tasklistsController($scope,tasks,sModal){function loadTaskLists(refresh){tasks.getTaskLists(refresh).then(function(data){$scope.taskLists=data})}function reloadList(){loadTaskLists(!0)}$scope.addNew=function(){sModal.open({scope:$scope,templateUrl:"tasklists/addTasklist.html"}).then(function(taskList){taskList&&tasks.createTaskList({title:taskList}).then(reloadList)})},$scope["delete"]=function(tasklistId){sModal.open({scope:$scope,controller:["$scope",function($scope){$scope.message="Tasklist will be deleted with all tasks in it. Proceed?"}],templateUrl:"components/templates/confirm.html"}).then(function(){tasks.deleteTaskList(tasklistId).then(reloadList)})},$scope.refresh=reloadList,$scope.rename=function(taskList){sModal.open({scope:$scope,controller:["$scope",function($scope){$scope.name=taskList.title}],templateUrl:"tasklists/addTasklist.html"}).then(function(newTitle){newTitle&&tasks.updateTaskList(taskList,{title:newTitle}).then(reloadList)})},loadTaskLists(!1)}tasklistsController.$inject=["$scope","tasks","sModal"],angular.module("tasklists").controller("tasklistsController",tasklistsController)}(),function(){"use strict";function addTask($scope,$routeParams,$modalInstance,tasks){$scope.newTask={},$scope.saveTask=function(){tasks.createTask($routeParams.id,{title:$scope.newTask.name}).then(function(){$modalInstance.close()})}}addTask.$inject=["$scope","$routeParams","$modalInstance","tasks"],angular.module("tasks").controller("addTaskController",addTask)}(),function(){"use strict";function tasksController($scope,$routeParams,sModal,tasks){function loadTasks(refresh){tasks.getTasks(tasklistId,refresh).then(function(data){$scope.tasks=data,$scope.total=data.total,$scope.completed=data.completed,$scope.todo=data.todo})}var tasklistId=$routeParams.id;$scope.title=$routeParams.title,$scope.addTask=function(){sModal.open({controller:"addTaskController",templateUrl:"tasks/addTask.html",scope:$scope}).then(function(){loadTasks(!0)})},$scope.deleteTask=function(taskId){sModal.open({scope:$scope,controller:["$scope",function($scope){$scope.message="Task will be deleted forever. Ok?"}],templateUrl:"components/templates/confirm.html"}).then(function(){tasks.deleteTask(tasklistId,taskId).then(function(){loadTasks(!0)})})},$scope.pinTask=function(){window.alert("pin: no idea yet")},$scope.changeStatus=function(task){"needsAction"===task.status&&delete task.completed,tasks.updateTask(tasklistId,task,{status:task.status}).then(function(){loadTasks(!0)})},loadTasks(!1)}tasksController.$inject=["$scope","$routeParams","sModal","tasks"],angular.module("tasks").controller("tasksController",tasksController)}();